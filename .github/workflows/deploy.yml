name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - dev
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: europe-central2
  BACKEND_IMAGE: dzenchat-api
  FRONTEND_IMAGE: dzenchat-web

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: üîë Set up Google Cloud credentials
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚öôÔ∏è Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: üê≥ Configure Docker to use Artifact Registry
        run: gcloud auth configure-docker "${{ env.REGION }}-docker.pkg.dev"

      # ---------- BACKEND BUILD ----------
      - name: üèóÔ∏è Build backend image
        run: |
          docker build \
            -f Dzen_chat.Api/Dockerfile \
            -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.BACKEND_IMAGE }}:latest" \
            .

      - name: üì¶ Push backend image
        run: |
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.BACKEND_IMAGE }}:latest"

      # ---------- FRONTEND BUILD ----------
      - name: üèóÔ∏è Build frontend image
        run: |
          docker build \
            -f frontend/Dockerfile \
            -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.FRONTEND_IMAGE }}:latest" \
            ./frontend

      - name: üì¶ Push frontend image
        run: |
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.FRONTEND_IMAGE }}:latest"

      # ---------- DEPLOY BACKEND ----------
      - name: üöÄ Deploy backend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: dzenchat-api
          region: ${{ env.REGION }}
          image: "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.BACKEND_IMAGE }}:latest"
          env_vars: |
            ASPNETCORE_ENVIRONMENT=Production
            CONNECTION_STRING=${{ secrets.CONNECTION_STRING }}
            RECAPTCHA__SECRETKEY=${{ secrets.RECAPTCHA_SECRET }}
            RECAPTCHA__EXPECTEDHOSTNAME=${{ secrets.RECAPTCHA_HOSTNAME }}

      # ---------- DEPLOY FRONTEND ----------
      - name: üöÄ Deploy frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: dzenchat-web
          region: ${{ env.REGION }}
          image: "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/dzenchat/${{ env.FRONTEND_IMAGE }}:latest"
